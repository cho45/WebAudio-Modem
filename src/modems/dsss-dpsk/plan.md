# DSSS-DPSK 堅牢性改善計画

## 概要

WebAudio-ModemのDSSS-DPSK変調方式において、様々な環境での安定的な信号同期・検出を実現するためのデータ駆動型改善計画。

「FECがあっても同期ができなければ無意味」という原則の下、同期の堅牢性を最優先で強化する。

## 1. 現状分析と問題点

### 1.1 既存の検証済み事実

**閾値設定の根拠（検証済み）**
- `correlationThreshold=0.5`の選択は包括的テストに基づく：
  - パラメータスイープテスト: 12通りの設定×0.4/0.5×20試行
  - Monte Carlo分析: 50試行での統計的検証  
  - ブラウザシミュレーション: 128サンプルチャンクでの実環境テスト
  - **結論**: 0.4は0.5より偽陽性率が明らかに高い（特にデモ設定seq15_spp23_sr44100で顕著）

**検証済みノイズ耐性**
- 複合ノイズでのテスト実施済み: 白色ノイズ、キャリア近傍干渉、DC漂移、周期パターン
- `peakToNoiseRatio=4`の妥当性は実測データに基づく

### 1.2 根拠が不足している問題領域

**探索範囲の限界（要検証）**
- 初期同期: 3ビット窓の妥当性（~~`MIN_SEARCH_WINDOW_BITS=1.5`は`SYNC_VALIDATION_BITS=12`と重複のため不要~~。M-sequence 3個分＝93chip分でノイズ耐性確保。しかし2ビット・4ビットとの性能比較データなし）
- ~~再同期: ±0.5チップの適切性~~ （理論的に自明：M-sequenceの自己相関特性により、既同期状態からの微調整では±0.5chip以内で十分な相関値を維持）
- 信号オフセット耐性の定量評価が未実施

**実環境性能データの不足**
- 音量変化に対する同期成功率の定量データなし
- 実際のSNR条件での性能特性が未測定
- 同期失敗の具体的原因分析が不十分

**振幅変動への対応状況（検証済み：AGC不要）**
- DSSS-DPSKではAGCが不要であることが実証済み
- 既存テスト `should maintain sync quality across different amplitude levels` で検証：
  - 振幅1.0〜0.01（100倍変化）で同期維持確認
  - 相関値 > 0.1、LLR平均 > 1 を全振幅で達成
- 相関計算での正規化処理（`normalizedCorr = correlation / (Math.sqrt(signalEnergy) * templateEnergy)`）が振幅不変性を保証

### 1.3 現在実装されている堅牢性機能

**実装済みエラー回復**
- 連続弱ビット検出: `CONSECUTIVE_WEAK_LIMIT=3`での同期切断
- 再同期機能: `±0.5チップ範囲`での周辺探索（理論的根拠：M-sequenceの自己相関特性）
- 品質監視: LLR値による信号品質評価

**実装済み信号処理**
- ノイズ推定キャッシュ: 10回に1回更新（`NOISE_UPDATE_INTERVAL=10`）
- 正規化相関: エネルギー正規化による振幅不変性
- デシメーション: `decimationFactor=2`での高速処理

### 1.4 検証が必要な具体的問題

**問題1: 同期失敗の原因特定**
- どのSNR条件で同期失敗が発生するか（定量データなし）
- `correlations`配列のどの範囲で偽ピークが発生するか
- `noiseFloor`推定（メディアンベース）の精度はどの程度か

**問題2: パフォーマンス制約の影響**
- `decimationFactor=2`による精度劣化の度合い
- AudioWorklet 2.9ms制限での処理可能範囲
- メモリ使用量と探索範囲拡大のトレードオフ

## 2. データ駆動型改善戦略

### Phase 1: 検証済み性能データの確認完了

**目標**: 既存の包括的テストカバレッジの確認と実際の不足領域の特定

#### 1.1 ~~SNR耐性の定量測定~~ （実装済み：包括的テスト完了）
- **検証済み内容**:
  - 既存テスト `should maintain sync and BER performance across multiple SNR levels with statistical validation`
  - SNR範囲: -18dB〜15dBまで包括的にテスト済み
  - 統計的検定: 100回試行による統計的信頼性確保済み
  - 偽陽性率テスト: `dsss-dpsk-comprehensive-false-positive.node.test.ts`で完全実装済み
- **結論**: 既存のSNRテストは十分網羅的であり、追加実装不要

#### 1.2 ~~振幅変動耐性の測定~~ （実装済み：既に検証済み）
- **検証済み内容**:
  - 既存テスト `should handle amplitude variation during transmission`
  - 既存テスト `should maintain sync quality across different amplitude levels` で実証済み
  - 振幅1.0〜0.01（100倍変化）での同期維持確認
  - 正規化相関による振幅不変性の有効性確認
- **結論**: AGC実装は不要

#### 1.3 探索範囲最適化の根拠データ（検証が必要な唯一の領域）
- **実装内容**:
  - 現在の3ビット窓 vs より大きな探索窓での同期成功率比較
  - AudioWorklet処理時間制約（2.9ms）内での実現可能性確認
  - デシメーション係数（現在=2）による精度への影響測定
- **測定指標**:
  - 窓サイズ vs 同期成功率（統計的信頼性95%）
  - 処理時間制約の実測（AudioWorklet環境）
  - メモリ使用量の実際の制約確認
- **実装箇所**: 新規テスト `tests/modems/dsss-dpsk-search-optimization.node.test.ts`

### Phase 2: 探索最適化データの分析 (実装が必要な唯一の領域)

**目標**: Phase 1で収集した探索範囲データから実装可能な改善を特定

#### 2.1 ~~同期失敗パターンの分析~~ （実装不要：既存テストで完全検証済み）
- **検証済み内容**:
  - SNR vs 失敗原因の相関: 既存の包括的SNRテストで分析済み
  - 偽ピーク発生の条件: `dsss-dpsk-comprehensive-false-positive.node.test.ts`で特定済み
  - `correlationThreshold` 0.4 vs 0.5 の差異は包括的に検証済み
- **結論**: 同期失敗の主要原因は既に特定済み

#### 2.2 ~~正規化処理の効果検証~~ （実装不要：既に検証済み）
- **検証済み内容**:
  - エネルギー正規化による振幅不変性は既存テストで実証済み
  - 正規化計算（`1e-12`加算による除算ゼロ回避）の有効性確認済み
- **結論**: 現在の正規化処理は適切であり、AGC追加は不要

#### 2.3 処理制約と探索最適化の分析（Phase 1データに基づく）
- **実装内容**:
  - Phase 1で収集した探索範囲データの分析
  - `decimationFactor=2` vs 他の値による精度・速度トレードオフ確認
  - AudioWorklet制約（2.9ms）での実現可能な探索範囲特定
- **分析項目**:
  - 探索範囲拡大による同期成功率向上の効果測定
  - 処理時間制約との兼ね合い
  - メモリ使用量の実用的上限確認
- **成果物**: 探索最適化の実装可否判定

### Phase 3: 根拠に基づく具体的改善実装 (低優先度)

**目標**: Phase 1-2の分析結果に基づく実装改善（データ根拠必須）

#### 3.1 同期検出の最適化（Phase 2分析結果次第）
- **前提条件**: Phase 2で偽ピーク発生パターンが特定されている場合のみ
- **実装内容**:
  - 特定された問題パターンへの対策実装
  - A/B テストでの改善効果検証
  - 統計的有意性の確認
- **実装制約**:
  - 既存性能を悪化させないこと
  - AudioWorklet制約内での実装
  - 計算コスト増加は5%以内

#### 3.2 探索範囲の最適化（Phase 1データに基づく）
- **前提条件**: Phase 1で明確な性能向上が確認されている場合のみ
- **実装内容**:
  - データ根拠のある範囲拡大実装
  - メモリ制約内での実現方法
  - 段階的な範囲調整機能
- **検証要件**:
  - 改善効果の統計的検定
  - メモリ使用量の監視
  - 処理時間の制約確認

#### 3.3 パラメータ調整の自動化（十分な根拠がある場合のみ）
- **前提条件**: Phase 1-2で自動調整の有効性が実証されている場合のみ
- **実装内容**:
  - 検証済みパラメータの動的調整
  - 保守的な調整範囲設定
  - フォールバック機能の実装
- **安全制約**:
  - 手動設定の優先保持
  - 調整範囲の制限
  - 異常検出時の自動停止

### Phase 4: 長期研究課題 (実装非推奨)

**現実性評価**: ブラウザ環境での制約により実装困難

#### 4.1 機械学習ベース適応（実装不推奨）
- **制約理由**: 
  - ブラウザでの機械学習は計算コスト過大
  - WebAudio AudioWorklet制約で実現困難
  - 投資対効果が疑問視される
- **代替案**: 統計的手法による簡易適応（Phase 3で検討）

#### 4.2 エコー・干渉対策（部分実装のみ検討可能）
- **制約理由**:
  - 高度なDSPアルゴリズムは専用ハードウェアレベル
  - リアルタイム処理制約で実現困難
- **現実的代替案**: 
  - 簡易的な干渉検出（閾値ベース）
  - 基本的なエコー検出（遅延パターン分析）

#### 4.3 プロトコルレベル改善（段階的検討）
- **実現可能性**: 中程度
- **実装条件**: Phase 1-3の結果次第
- **制約**: 既存XModem互換性の維持必須

## 3. 実装戦略と成功条件

### Phase 1: 探索範囲最適化データの収集

#### 実装戦略
- **技術的実現性**: ★★★☆☆ (中程度)
- **根拠**:
  - AudioWorklet処理時間制約（2.9ms）の実測が必要
  - 既存テスト手法の流用可能だが、新しい測定軸が必要
  - デシメーション係数の変更は既存ロジックに影響
- **実装コスト**: 中程度（2-3週間）
- **リスク**: 中程度（既存性能への影響可能性）

#### 成功条件と指標
- **必要成果**: 探索範囲と処理制約の定量的関係データ
- **合格基準**: 
  - 現在の3ビット窓 vs 拡張窓での同期成功率差異の統計的検定
  - AudioWorklet処理時間が2.9ms以内での実現可能性確認
  - メモリ使用量増加が実用範囲内（<10MB）
- **データ品質**: 統計的信頼性95%レベル

#### 期待される発見
- 探索範囲拡大による実際の同期成功率向上効果
- AudioWorklet制約下での実現可能な最大探索範囲
- デシメーション係数変更の精度・速度トレードオフ

### Phase 2: データ分析と問題特定

#### 実装戦略
- **技術的実現性**: ★★★★☆ (高い)
- **根拠**:
  - Phase 1で収集されたデータの分析
  - 既存の統計処理ツールの活用
  - 明確な分析フレームワークの適用
- **実装コスト**: 中程度（2-3週間）
- **リスク**: 低い（データ分析のみ）

#### 成功条件
- **必要成果**: 同期失敗の根本原因特定
- **合格基準**:
  - 失敗原因の上位3要因を特定
  - 各要因の改善可能性評価完了
  - AGC必要性の明確な結論
- **分析品質**: 統計的有意性検定実施

### Phase 3: 根拠に基づく改善実装

#### 実装戦略  
- **技術的実現性**: データ次第
- **実装条件**: Phase 1-2で明確な改善根拠がある場合のみ
- **実装コスト**: 変動（改善内容による）
- **リスク**: 中程度（既存機能への影響可能性）

#### 成功条件
- **必要成果**: データ根拠のある改善実装
- **合格基準**:
  - 改善効果の統計的検定で有意性確認
  - 既存性能の非劣化
  - AudioWorklet制約内での実装
- **検証品質**: A/Bテストによる客観的評価

## 4. 推奨実装順序（データ駆動型）

### 第1段階: 探索範囲最適化データ収集のみ (2-3週間)
1. ~~**SNR耐性測定テスト実装**~~ （実装済み：包括的テスト完了）
   - 既存テストで-18dB〜15dBまで検証済み
   - 統計的信頼性も十分確保済み

2. ~~**振幅変動耐性測定テスト実装**~~ （実装済み：既存テストで検証済み）
   - AGC不要であることは既に実証済み

3. **探索範囲最適化データ収集**（実装が必要な唯一の項目）
   - 現在の3ビット窓の制約確認
   - AudioWorklet処理時間制約の実測
   - デシメーション係数最適化の検証

### 第2段階: 探索最適化データ分析 (1-2週間)
4. ~~**収集データの統計分析**~~ （大部分は実装済み）
   - 同期失敗原因: 既存の包括的SNRテストで特定済み
   - AGC必要性: 既に結論済み（不要）
   - **唯一必要**: 探索範囲最適化の効果分析

### 第3段階: 探索最適化実装 (効果が実証された場合のみ)
5. **探索範囲改善の実装**（Phase 1-2で効果が実証された場合のみ）
   - データで効果が実証された探索範囲拡大のみ
   - AudioWorklet制約内での実装
   - 保守的なアプローチで安全性確保

### 実装不要項目（既存テストで検証済み）
- **SNR耐性テスト**: 既存の包括的テストで完了
- **振幅変動テスト**: 既存テストで検証済み
- **偽陽性率テスト**: 既存の専用テストファイルで完了
- **相関閾値最適化**: 0.4 vs 0.5 は既に包括的に検証済み
- **Phase 4全項目**: 技術的制約により実装困難

## 5. データ品質要件

### 統計的信頼性
- **試行回数**: 最低100回（統計的信頼性95%確保）
- **再現性**: 同一条件で複数回実施、結果の一貫性確認
- **バイアス除去**: ランダム化による系統誤差の排除

### 測定環境
- **統制条件**: ノイズ種別、SNR、振幅を厳密に制御
- **現実性**: 実際の使用環境を模擬した条件での検証
- **網羅性**: 想定される使用範囲を完全にカバー

### データ品質管理
- **異常値検出**: 統計的手法による外れ値の特定と除外
- **データ完整性**: 欠損データや測定エラーの確認
- **結果検証**: 独立した手法による結果の交差検証

## 6. 成功条件（データ駆動型）

### Phase 1の成功条件
- **SNR特性の定量化**: 各SNRレベルでの同期成功率データ
- **振幅不変性の検証**: 正規化の効果を数値で実証
- **処理制約の把握**: メモリ・計算時間の限界値特定

### Phase 2の成功条件  
- **問題原因の特定**: 失敗の主要3要因を統計的に確認
- **改善方向の明確化**: 実装すべき改善項目を根拠と共に提示
- **処理制約の明確化**: AudioWorklet制約内での実現可能な改善範囲特定

### Phase 3の成功条件（該当する場合のみ）
- **改善効果の実証**: 統計的検定による有意な改善確認
- **安全性の保証**: 既存性能の非劣化を統計的に証明
- **運用安定性**: 長期間の安定動作確認

## 7. 次ステップ（大幅な縮小）

1. ~~**SNR耐性測定テスト**の実装開始~~ （完了済み：既存の包括的テストで十分）
2. **探索範囲最適化テスト**の実装のみ（唯一不足している項目）
3. ~~テストフレームワークの整備~~ （既存フレームワークで十分）
4. ~~データ収集・分析手法の確立~~ （既存手法で十分）
5. ~~統計的検定手法の準備~~ （既存テストで実装済み）

---

**更新履歴**
- 2025-01-06: 初版作成（抽象的計画）
- 2025-01-06: データ駆動型に全面改訂、既存検証済み事実を反映、測定可能な改善計画に変更
- 2025-01-06: 既存テストカバレッジ確認後の大幅縮小改訂
  - SNR耐性テスト(-18dB〜15dB)は実装済みと確認
  - 振幅変動テストは実装済みと確認  
  - 偽陽性率テストは専用ファイルで完全実装済みと確認
  - 残る改善項目: 探索範囲最適化のみに絞り込み