# WebAudio DSSS+DPSK PoC 実装ステップ

## フェーズ1: オフライン信号処理PoC（段階的ステップと検証内容）
1. DPSK変調・復調のみ（DSSSなし）でbit誤り率・動作確認
   - パラメータ: **搬送波10kHz**, **サンプリングレート48kHz**（WebAudio標準）, **シンボルレート自動計算**
   - まずは「ビット列→DPSK変調→サンプル列」を生成し、同期がとれている（シンボル境界が既知）前提で復調し、bit誤り率0となることを確認する。DPSKアルゴリズム自体の正しさを検証。
2. DSSS拡散・逆拡散を追加し、DSSS+DPSKでのbit誤り率・同期性能を評価
   - パラメータ: **M系列拡散率31**（生成多項式x⁵+x³+1, シード任意非0）, **1チップあたりのサンプル数自動計算**
   - DSSSの自己相関特性を利用した系列同期（コード同期）を実装。変調済みサンプルの先頭を意図的にオフセットしても、同期点を自動検出し正しく復調できるかを検証。DSSSの同期性能・頑健性を評価。
   - プリアンブル: **PN系列の一部をそのまま使用**
   - 同期検出: **スライディング相関法**、ウィンドウ長=拡散率、**相関ピーク比2.0以上で同期成立**、**相関ステップ幅=1サンプル**
   - 再同期: **1000シンボルごとに再探索**
3. soft value（信頼度値）出力・可視化対応
   - 復調時にsoft value（信頼度値, **int8_t -128～+127**）を出力し、ヒストグラムや散布図などで可視化。soft-decision FECへの入力値としての有用性も検証。
4. データフレーム解析（SOH/長さ/CRC等の検出・抽出、soft value活用）
   - フレーム構造: 下記「データフレーム構造（ASCIIアート）」参照
   - 復調soft value列から、データフレーム層でSOH/長さ/CRC等を検出・抽出し、データ本体部分を切り出す。
   - SOHや長さ等FEC非保護フィールドのsoft valueも活用し、信頼度が低い場合はフレーム破棄・再同期等の処理を行う。
5. FEC（LDPC）を追加し、誤り訂正前後の性能比較
   - パラメータ: **LDPC n=128, rate=1/2, H行列固定, 反復10回, soft値int8_t**
   - データ本体部分のみをFEC復号にかけ、FECなし・ありでbit誤り率や復元率がどれだけ改善されるかを比較評価。
6. テストデータをDSSS+DPSK変調し、AudioBufferやWAVファイルに出力
   - 生成した信号をファイル出力し、外部ツール等で波形やスペクトルも確認。
7. 変調信号を復調・逆拡散し、元データと一致するか確認
   - 端末間や異なる環境での再現性・互換性も含めて最終検証。

## フェーズ2: WebAudioリアルタイムPoC
1. AudioContextで信号を再生する送信処理の実装
   - **サンプリングレート48kHz, AudioWorkletバッファ128サンプル**
   - ブラウザ上でリアルタイムにDSSS+DPSK信号を生成・再生できるかを検証。
2. マイク入力を録音し、バッファに格納する受信処理の実装
   - マイク経由で受信した信号をバッファ化し、オフラインと同等の復調・逆拡散ができるかを検証。
3. 録音データにDPSK復調＋DSSS逆拡散を適用
   - 実環境ノイズ・歪み下での復調性能・同期性能を評価。
4. soft valueをFEC（LDPC）に渡し、誤り訂正の有無を確認
   - FECの有無でリアルタイム伝送の誤り耐性がどれだけ向上するかを評価。

## フェーズ3: 統合・UI・評価
1. 送信・受信UI、パラメータ調整UIの作成
   - ユーザーが各種パラメータを調整しながら伝送実験できるUIを実装。
2. BER/SNR等の簡易評価指標の表示
   - 伝送品質をリアルタイムで可視化し、各種パラメータの影響を評価。
3. ノイズ・歪み耐性の実験・記録
   - 様々な環境・条件下での伝送性能を記録・比較し、システムの実用性・限界を検証。

- まずはオフラインでbit誤り率や復元率を確認し、次にWebAudio経由での信号劣化・復調性能を評価する。
- 既存のDPSK/FSKデモやWebAudio録音・再生サンプルを流用すると効率的。
- DPSKを使うことで搬送波同期が不要になり、PoC実装が容易になる。

---

## 実装前に決定すべき具体的な項目（利用フェーズ・必要順）
- **DPSK変調パラメータ**（フェーズ1-2）
  - 搬送波周波数:
    - **PC/スマホ標準（20Hz～20kHz）**: 8kHz～12kHz推奨（例: 10kHz）
    - **ノートPC内蔵マイク/スピーカー**: 3kHz～7kHz推奨（例: 5kHz）
    - **電話回線/VoIP（300Hz～3.4kHz）**: 1kHz～2kHz推奨（例: 1.5kHz）
    - ※帯域端は減衰・歪みが大きいため、中心付近を選ぶ
  - サンプリングレート（WebAudioのサンプリングレートと**必ず一致させる**）
  - シンボルレート（サンプルレート÷1シンボルあたりのサンプル数で自動的に決まる）
- **PN系列の種類・パラメータ**（フェーズ1-2）
  - M系列 or Gold系列 or Walsh系列 → M系列
  - シード値・生成多項式・系列長（拡散率
- **DSSSパラメータ**（フェーズ1-2）
  - 拡散率（系列長）
  - 1チップあたりのサンプル数（サンプルレート・シンボルレート・拡散率から自動的に決まる：
    1チップあたりのサンプル数 = サンプルレート ÷ (シンボルレート × 拡散率)
    または 1シンボルあたりのサンプル数 ÷ 拡散率）
- **プリアンブル設計**（フェーズ1-2）
  - PN系列の一部をそのまま使う（系列同期・コード同期のため、DPSK+DSSS段階から必要）
- **同期検出アルゴリズム**（フェーズ1-2）
  - スライディング相関法（自己相関法）を採用
    - 相関ウィンドウ長（通常はプリアンブル長＝拡散率）
    - 相関しきい値（ピーク比（最大値/平均値や2番目ピーク）による判定が現実的）
    - 探索範囲・ステップ幅（何サンプル単位で相関をスライドさせるか）
      - **ステップ幅（相関のスライド間隔）は「1サンプル」または「1/2チップ幅以下」が推奨**
        - 1チップあたりのサンプル数が十分大きい場合は「1サンプル」ごとに相関を計算することで、ピーク検出の精度が最大化される。
        - 計算量削減のため「1/2チップ幅」ごと（例: 1チップ=8サンプルなら4サンプルごと）でも、ピーク検出の精度は大きく損なわれない。
        - **「1チップ幅」ごと（=チップ単位）だと、ピークを見逃すリスクが高まる**ため、最低でも「1/2チップ幅」ごとが推奨される。
        - 相関ピークはチップ境界に必ずしも一致せず、サンプリングのズレや信号歪みでピーク位置がサンプル単位で前後するため、粗いステップだと最大値を検出できない場合がある。
      - **実装例**: 1チップ=8サンプルなら、4サンプルごと（1/2チップ幅）または1サンプルごとに相関を計算する。
      - **計算量と精度のトレードオフ**: ステップ幅を小さくするほど計算量は増えるが、同期精度・ピーク検出精度が向上する。
    - 再同期戦略（同期ロス時の再探索方法）
      - 音声帯域・WebAudio等の端末間通信では、送信側・受信側のサンプリングクロックの微小なズレ（クロックドリフト）により、数秒以上の伝送でチップ境界がサンプル単位で徐々にずれていく現象が現実的に発生する。そのため、長時間伝送や端末間通信では「再同期戦略」は必須設計項目となる。
      - 具体的な再同期戦略例：
        - **一定区間ごと（例: Nシンボルごと）に再度プリアンブル探索を行い、同期点を補正する**
          - （補足）これは「受信データ列の中で、サンプル位置（チップ境界）がクロックドリフト等でずれていないかを、プリアンブルとの相関ピークで再検出し、ピーク位置に合わせてサンプルの区切り（チップ/シンボルの開始点）を補正する」ための処理です。
          - Nの目安：サンプリングレート48kHz・シンボルレート1kHz・クロックドリフト50ppmの場合、1チップ=8サンプルなら約3300シンボルごと（約3秒ごと）で1チップ分ずれる。実用上は1000～5000シンボルごと（1～5秒ごと）に再同期すれば十分。
        - 復調結果のエラー率や信頼度（soft value）が悪化したら再探索をトリガーする
        - 連続したビットエラーやFEC復号失敗を検出したら再探索する
        - 受信信号のエネルギー低下や異常値を検出したら再探索する
        - 常にスライディングウィンドウで並行して同期点を監視し、ピークがずれたら自動補正する（計算量は増えるがリアルタイム性が高い）
      - どの戦略を採用するかは、伝送時間・計算量・リアルタイム性の要求に応じて選択する。
    - 多重ピーク対策（複数ピーク時の選択基準）
      - 理想的には「最大ピーク＝本物の同期点」だが、ノイズや周期性の影響で偽ピークが最大値になる場合がある。
      - 対策例：
        - 最大ピークと2番目ピークや平均値との比（ピーク比）が十分大きい場合のみ同期成立とみなす
        - ピーク比が閾値未満なら「同期失敗」として再探索する
        - 連続した複数回の相関計算で同じ位置にピークが現れる場合のみ同期点とする
      - 偽ピークによる誤同期を防ぐため、最大値以外の判定基準も重要。
- **FEC方式・パラメータ**（フェーズ1後半-2以降）
  - LDPC
    - 決定すべき主なパラメータ：
      - **符号長（n）**: 1ブロックあたりの総ビット数（例: 128, 256, 512, 1024など）
      - **情報ビット長（k）**: 1ブロックあたりの元データ（情報ビット）数
      - **符号化率（rate = k/n）**: 例: 1/2, 2/3, 3/4 など
      - **パリティ検査行列（H行列）の構造**: ランダム型 or 構造化型（QC-LDPC等）
      - **反復復号回数（最大反復数）**: 例: 10回, 20回, 50回など
      - **ソフト値入力のスケーリング・量子化方法**: 例: 8bit int（-128～+127）で正規化、またはfloat
    - **実装上の可変性について**
      - rateやn（符号長）は「H行列（パリティ検査行列）」の内容次第で可変可能。
      - ただし、H行列のサイズ・構造が異なる場合は、事前に複数のH行列を用意するか、動的生成ロジックが必要。
      - 一般的なLDPCライブラリでは、rateやnごとにH行列を切り替える設計が多い。
      - PoCや実験段階では「H行列を固定し、rateやnも固定」とし、必要に応じて複数パターンを切り替える方式が現実的。
      - 本格実装では「H行列の動的生成」や「rate/n可変対応」も可能だが、実装コストが上がる。
- **WebAudio関連**（フェーズ2以降）
  - サンプリングレート（AudioContext作成時にブラウザが決定する値。通常は44100Hzまたは48000Hzで固定）
  - AudioWorkletの処理単位フレーム数（バッファサイズ）：128サンプルで固定（WebAudio仕様上、process()ごとに128サンプルずつストリーム処理）
  - 必ずストリーム処理となる。128サンプル単位で逐次処理される。
- **データフレーム構造**（フェーズ2-3）
  - 推奨構成：`SOH(1B)` + `ペイロード(最大255B)`
    - SOH: フレーム開始・LDPC符号長種別（上位6bit:フレーム開始, 下位2bit:LDPC n種別）
    - ペイロード: データ本体 + CRC16（FEC保護領域, LDPC符号長nに対応した固定長）
      - データ: ユーザデータ本体
      - CRC16: データ本体の末尾に付加（例: CRC-16-CCITT, 2バイト）
    - ※ペイロード全体（データ+CRC）をFEC（LDPC）で符号化する
  - FEC（LDPC等）は「ペイロード（データ+CRC）」部分全体に適用する。
    - ヘッダ（SOH）はFEC非保護。SOHのsoft valueも活用し、信頼度が低い場合はフレーム破棄・再同期等の処理を行う。
    - CRCをFEC保護領域に含めることで、FEC訂正能力がCRCにも及び、誤り検出の信頼性が最大化される。
    - FEC復号後にCRC検証を行い、FECで訂正しきれなかった誤りやundetected errorを確実に検出する。
  - 必要に応じて拡張フィールド（種別・シーケンス番号等）を追加可能。
- **評価指標**（全フェーズ）
  - BER（Bit Error Rate, ビット誤り率）: 送信ビット数に対する誤りビット数の割合。通信品質の基本指標。
  - SNR（Signal to Noise Ratio, 信号対雑音比）: 復調前後の信号パワーと雑音パワーの比（dB単位）。高いほど雑音耐性が高い。
  - 同期成功率: プリアンブルや系列同期が正しく検出できた割合。全試行数に対する同期成功回数の比率。
  - 処理遅延: 送信から復調・復元までにかかる総遅延時間（ms単位）。リアルタイム性や応答性の指標。

---

**受信処理フローの注意：**
- 復調後のsoft value列から、まずデータフレーム層でSOH/長さ/CRC等を（soft valueも活用しつつ）検出・抽出し、
- データ本体部分のみをFEC復号にかける。
- FEC復号は「データ本体」部分のみで、フレーム境界や長さが分からないとFEC復号できないため、
  「データフレーム層での境界検出・抽出」がFEC復号より先に必要となる。

---

---

- **DSSSで1対1通信・同期重視ならM系列が最もシンプルで堅牢**
- **多重化や複数ユーザー対応ならGold系列やWalsh系列が有利*
- **自己相関ピークの鋭さ・同期のしやすさはM系列＞Gold系列＞Walsh系列**

## M系列（最大長系列）生成多項式リスト（n≦7, 拡散率≦127）

| 段数n | 周期（拡散率） | 代表的な多項式（タップ位置） |
|-------|----------------|-----------------------------|
| 3     | 7              | x³ + x² + 1   （3,2）      |
| 4     | 15             | x⁴ + x³ + 1   （4,3）      |
| 5     | 31             | x⁵ + x³ + 1   （5,3）      |
| 6     | 63             | x⁶ + x⁵ + 1   （6,5）      |
| 7     | 127            | x⁷ + x⁶ + 1   （7,6）      |

- いずれもLFSRの「n段目」と「タップ位置」をXORしてフィードバックします。
- シード（初期値）は1以外の任意値（0は不可）
- 例：n=7, 多項式x⁷+x⁶+1 → LFSRの7,6ビットをXOR

---

- 拡散率31, 63, 127などが音声帯域DSSSで現実的な選択肢です。
- さらに大きなnや他の多項式が必要な場合はご相談ください。

## 拡散率・系列長・位相数について
- **拡散率＝系列長＝位相数** となります。
  - 例：拡散率31 → PN系列長31 → 位相数31（開始位置が31通り）
  - 例：拡散率127 → PN系列長127 → 位相数127
- コード同期時は「系列の全位相（開始位置）」で相関計算し、最大値の位置を系列の先頭とみなします。
- **拡散率が高いほど計算量が多くなりますが、同期精度・耐雑音性（処理利得）も高くなります。**

### 拡散率のトレードオフ
- 拡散率↑（系列長↑）
  - 長所: 雑音・干渉に強くなる（SNR改善、誤検出減少）、同期精度が上がる
  - 短所: 同期探索の計算量が増える、データレートが下がる（1ビットあたりのチップ数増加）
- 拡散率↓（系列長↓）
  - 長所: 計算量が少なく、データレートが高い
  - 短所: 雑音・干渉に弱くなり、同期誤検出も増える

## データフレーム構造（ASCIIアート）

  +----------+---------------------------+
  |   SOH    |   ペイロード（=データ+CRC）|
  +----------+---------------------------+
  | 8bit     | n/8 bytes                 |
  +----------+---------------------------+
      |           |
      |           +-- LDPC符号長nに対応した固定長データ（データ本体+CRC16）
      |
      +-- SOH (8bit) 内訳:
          +---+---+---+---+---+---+---+---+
          | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
          +---+---+---+---+---+---+---+---+
          |<----フレーム開始識別---->|<--n-->| 
          |         上位6bit       |  2bit |

  ※SOH下位2bitでLDPC符号長（例: 00=128, 01=256, 10=512, 11=2040bit）を指定

#### SOH下位2bit→LDPC符号長 割り当て（最大255バイト制約）

| SOH下位2bit | n（符号長[bit]） | ペイロード長[byte] |
|:-----------:|:----------------:|:------------------:|
|     00      |      128         |       16           |
|     01      |      256         |       32           |
|     10      |      512         |       64           |
|     11      |     2040         |      255           |

- 00, 01, 10は標準的な2のべき乗（128, 256, 512）
- 11のみ最大値（255バイト=2040bit）
- 2048bit（=256バイト）はCRCやヘッダを含めるとオーバーするため避ける

この割り当てにより、最大ペイロード255バイト制約を守りつつ、実験的な小～大容量まで柔軟に対応できる。

---

### CRC配置・FECとの関係

- **本設計では「CRC16をデータ本体の末尾に付加し、ペイロード全体（データ+CRC）をFEC（LDPC）で符号化する」方式とする。**
- これは「FEC復号後にCRC検証を行う」ことで、
  - FECで訂正しきれなかった誤り
  - まれに発生する「誤ったデータがLDPCのパリティ検査をすべて満たしてしまう（undetected error）」
  を確実に検出するため。
- **CRCをFEC保護領域に含めることで、FECの訂正能力がCRCにも及び、誤り検出の信頼性が最大化される。**
